{% extends "layout/base.html" %}

{% block sidebar %}
	{% include 'purchases/_sub_menu.html' %}
{% endblock %}

{% block private_js %}
<script type="text/javascript">
	var recount = function () {
		var total_quantity=0, total_amount=0, sku_count=0;
		$('input.quantity').each(function () {
			var quantity = parseInt($(this).val()), sku_id = $(this).data('id');
			var price = parseFloat($('#cost_price_' + sku_id).html());
			sku_count += 1;
			total_quantity += quantity;
			total_amount += price*quantity;
		});
		$('#sku_count').html(sku_count);
		$('#purchase_quantity').html(total_quantity);
		$('#total_amount').html('￥'+total_amount.toFixed(2));
	};

	var parse_result = function (skus) {
		var tr_html = [];
		for (var i=0,l=skus.length; i<l; i++) {
			tr_html.push('<tr id="tr_sku_'+ skus[i].id +'">');
			tr_html.push('<td class="text-center"><img src="'+ skus[i].cover +'" width="60px"></td>');
			tr_html.push('<td>'+ skus[i].serial_no +'</td>');
			tr_html.push('<td class="text-center"><label class="label label-warning">'+ skus[i].s_model +'</label></td>');
			tr_html.push('<td class="text-center"><label id="cost_price_'+ skus[i].id +'">'+ skus[i].cost_price +'</label></td>');
			tr_html.push('<td class="text-center"><input type="text" class="form-control quantity" data-id="'+ skus[i].id +'" name="sku['+ skus[i].id +'][quantity]" size="5" value="1"></td>');
			tr_html.push('<td class="text-right"><span id="amount_'+ skus[i].id +'">'+ (skus[i].cost_price*1).toFixed(2) +'</span></td>');
			tr_html.push('<td class="text-right"><button role="button" class="btn btn-icon ajax-delete-sku btn-danger">'+
				'<i class="glyphicon glyphicon-trash"></i></button>'+
				'<input type="hidden" name="sku[]" value="'+ skus[i].id +'">' +
				'</td>');
			tr_html.push('</tr>');
		}
		return tr_html.join('');
	};
</script>
{% endblock %}

{% block jquery %}
{#<script type="text/javascript">#}
	$('#add-product-btn').click(function (e) {
		var $btn = $(this), post_url=$(this).attr('href');
		var supplier_id = $('#supplier_id').find(':selected').eq(0).val();
		if (supplier_id == 0) {
			alert('请先选择供应商');
			return false;
		}
		$('#sku-modal').remove();
		$.ajax({
			url: post_url,
			dataType: 'html',
			data: {'supplier_id': supplier_id},
			beforeSend: function() {
				$btn.prop('disabled', true);
			},
			complete: function() {
				$btn.prop('disabled', false);
			},
			success: function(html) {
				$('body').append('<div id="sku-modal" role="dialog" class="modal">' + html + '</div>');

				$('#sku-modal').modal('show');
			}
		});
		return false;
	});

	$('.ajax-delete-sku').click(function () {
		var post_url = $(this).attr('href');
		$.post(post_url, {'csrf_token': csrf_token}, function (result) {
			if (result.success) {
				$('#tr_sku_'+ result.data.id).remove();
			}
		}, 'json');
		return false;
	});

	$(document).on('change', 'input.quantity', function(e) {
		var quantity = parseInt($(this).val()), sku_id = $(this).data('id');
		var price = parseFloat($('#cost_price_' + sku_id).html());
		$('#amount_' + sku_id).html((price*quantity).toFixed(2));

		recount();
	});

{#</script>#}
{% endblock %}

{% block mainbar %}
<div class="form-page">
	<h2 class="page-header">
		{% if mode == 'create' %}
		{{ _('Add Purchase') }}
		{% else %}
		{{ _('Edit Purchase') }}
		{% endif %}

		<span class="pull-right">
			<button type="submit" form="purchase-form" class="btn btn-icon btn-primary" data-toggle="tooltip" data-original-title="{{ _('Save') }}">
				<i class="glyphicon glyphicon-floppy-save"></i>
			</button>
			<a href="{{ url_for('main.show_purchases') }}" class="btn btn-icon btn-default" data-toggle="tooltip" data-original-title="{{ _('Cancel') }}">
				<i class="glyphicon glyphicon-share-alt"></i>
			</a>
		</span>
	</h2>

	<form id="purchase-form" class="form-horizontal" action="" method="post">
		<input type="hidden" name="csrf_token" value="{{ csrf_token() }}" >

		<div class="form-group required">
			{{ form.warehouse_id.label(class="col-sm-2 control-label") }}
			<div class="col-sm-4 m-b-10">
				<select name="warehouse_id" id="warehouse_id" class="form-control select2">
					<option value="0">{{ _('Select warehouses') }}</option>
					{% for w in warehouses %}
					<option value="{{ w.id }}" {% if w.id == purchase.warehouse_id %}selected="selected"{% endif %}>{{ w.name }}</option>
					{% endfor  %}
				</select>
				{% for error in form.errors.warehouse_id %}
				<span class="help-block">{{ error }}</span>
				{% endfor %}
			</div>
		</div>

		<div class="form-group required">
			{{ form.supplier_id.label(class="col-sm-2 control-label") }}
			<div class="col-sm-4 m-b-10">
				<select name="supplier_id" id="supplier_id" class="form-control select2">
					<option value="0">{{ _('Select suppliers') }}</option>
					{% for s in suppliers %}
					<option value="{{ s.id }}" {% if s.id == purchase.supplier_id %}selected="selected"{% endif %}>{{ s.name }}</option>
					{% endfor  %}
				</select>
				{% for error in form.errors.supplier_id %}
				<span class="help-block">{{ error }}</span>
				{% endfor %}
			</div>
		</div>

		<div class="form-group form-group-lg">
			<div class="col-sm-5">
				<a href="{{ url_for('main.ajax_search_products') }}" class="btn btn-primary" id="add-product-btn" role="button" data-toggle="tooltip" data-original-title="{{ _('Select Products') }}">
					<i class="glyphicon glyphicon-plus"></i> {{ _('Select Products') }}
				</a>
			</div>
			<div class="col-sm-7 text-right">
				<label class="control-label">
					SKU种类：<span id="sku_count" class="text-danger">{{ purchase.sku_count|default(0) }}</span>， 采购数量：<span id="purchase_quantity" class="text-danger">{{ purchase.quantity_sum|default(0) }}</span>， 总价：<span id="total_amount" class="text-danger">￥{{ purchase.total_amount|default(0) }}</span>
				</label>
			</div>
		</div>

		<table class="table table-bordered m-t-20 m-b-30">
			<thead>
				<tr>
					<th class="text-center">{{ _('Product Image') }}</th>
					<th>{{ _('Product Name') }}</th>
					<th class="text-center">{{ _('Product Model') }}</th>
					<th class="text-center">{{ _('Purchase Price') }}</th>
					<th class="text-center">{{ _('Purchase Quantity') }}</th>
					<th class="text-right">{{ _('Total Amount') }}</th>
					<th class="text-right">Action</th>
				</tr>
			</thead>
			<tbody id="choose-products">
				{% for item in purchase.products %}
				<tr id="tr_sku_{{ item.sku.id }}">
					<td class="text-center">
						<img src="{{ item.sku.cover.view_url }}" width="60px">
					</td>
					<td>
						{{ item.sku.serial_no }}
					</td>
					<td class="text-center">
						<label class="label label-warning">{{ item.sku.s_model }}</label>
					</td>
					<td class="text-center">
						<label id="cost_price_{{ item.sku.id }}">{{ item.cost_price }}</label>
					</td>
					<td>
						<input type="text" class="form-control quantity" data-id="{{ item.sku.id }}" name="sku[{{ item.sku.id }}][quantity]" size="5" value="{{ item.quantity }}">
					</td>
					<td class="text-right">
						<span id="amount_{{ item.sku.id }}">{{ item.cost_price*item.quantity }}</span>
					</td>
					<td class="text-right">
						<button role="button" class="btn btn-icon ajax-delete-sku btn-danger" data-toggle="tooltip" data-original-title="{{ _('Delete') }}">
							<i class="glyphicon glyphicon-trash"></i>
						</button>
						<input type="hidden" name="sku[]" value="{{ item.sku.id }}">
					</td>
				</tr>
				{% endfor %}
			</tbody>
		</table>

		<div class="form-group">
			{{ form.freight.label(class="col-sm-1 control-label") }}
			<div class="col-sm-2">
				<div class="input-group">
					{{ form.freight(id="freight", class="form-control") }}
					<span class="input-group-addon">
						CNY
					</span>
				</div>
			</div>
			{{ form.extra_charge.label(class="col-sm-2 control-label") }}
			<div class="col-sm-2">
				<div class="input-group">
					{{ form.extra_charge(id="extra_charge", class="form-control")}}
					<span class="input-group-addon">
						CNY
					</span>
				</div>
			</div>
			{{ form.arrival_date.label(class="col-sm-2 control-label") }}
			<div class="col-sm-3">
				<div class="input-group">
					{{ form.arrival_date(id="arrival_date", class="form-control") }}
					<span class="input-group-addon">
						<i class="glyphicon glyphicon-calendar"></i>
					</span>
				</div>

			</div>
		</div>

		<div class="form-group form-group-lg">
			{{ form.description.label(class="col-sm-1 control-label") }}
			<div class="col-sm-11">
				{{ form.description(id="description", class="form-control") }}
			</div>
		</div>


	</form>

</div>
{% endblock %}