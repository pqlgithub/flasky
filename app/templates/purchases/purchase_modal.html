<div class="modal-dialog modal-lg" role="document">
	<div class="modal-content">
		<div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
			<h4 class="modal-title">{{ _('Search Products') }}</h4>
		</div>
		<div class="modal-body">
			<form class="form form-inline" action="" method="post" id="sku-form">
				<input type="hidden" name="csrf_token" value="{{ csrf_token() }}" >
				<input type="hidden" name="supplier_id" value="{{ supplier_id }}">

				<div class="form-group">
					<input type="text" name="qk" class="form-control searcher" size="80" placeholder="{{ _('Search sku or name...') }}" >
				</div>

				<div class="form-group m-l-10">
					<div class="dropdown">
						<input type="hidden" name="reg_id" value="{{ reg_id }}">
						<button class="btn btn-default dropdown-toggle" id="filter-region" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
							{{ _('Region') }}: <b>{{ _('All') }}</b>
							<span class="caret"></span>
						</button>
						<ul class="dropdown-menu dropdown-select-menu" data-target="reg_id" aria-labelledby="filter-region">
							<li class="dropdown-header">{{ _('Search Region')}}</li>
							<li class="divider" role="separator"></li>
							<li>
								<a href="javascript:void(0);" data-id="0" class="option">{{ _('All') }}</a>
							</li>
							{% for r in default_regions %}
							<li>
								<a href="javascript:void(0);" data-id="{{ r['id'] }}" class="option">{{ r['name'] }}</a>
							</li>
							{% endfor %}
						</ul>
					</div>
				</div>

				<div id="table-refresh-box">
					<table class="table table-bordered m-t-20">
						<thead>
							<tr>
								<th class="text-center">
									<input name="check_all" type="checkbox" class="check-all">
								</th>
								<th class="text-center">{{ _('Image') }}</th>
								<th class="text-center">{{ _('SKU') }}</th>
								<th>{{ _('Product Name') }}</th>
								<th class="text-center">{{ _('Attributes') }}</th>
								<th class="text-right">{{ _('Price') }}</th>
								<th class="text-right">{{ _('Total Stock / Not Arrived') }}</th>
							</tr>
						</thead>
						<tbody id="purchase-items">
						{% for sku in paginated_skus.items %}
						<tr id="tr_sku_{{ sku.id }}">
							<td class="text-center">
								<input name="selected[]" class="check-one" value="{{ sku.id }}" type="checkbox">
							</td>
							<td class="text-center">
								<img src="{{ sku.cover.view_url }}" width="60px">
							</td>
							<td class="text-center">
								{{ sku.serial_no }}
							</td>
							<td>
								{{ sku.product.name }}<br>
								{% if sku.product.region_id == 1 %}
								<span class="text-mixpus">{{ sku.product.region_label.get('name') }}</span>
								{% endif %}

								{% if sku.product.region_id == 2 %}
								<span class="text-warning">{{ sku.product.region_label.get('name') }}</span>
								{% endif %}
							</td>
							<td class="text-center">
								{% if sku.s_model %}
								<label class="label label-warning">
									{{ sku.s_model|supress_none }}
								</label>
								{% endif %}
								{% if sku.s_color %}
								<label class="label label-default">
									{{ sku.s_color|supress_none }}
								</label>
								{% endif %}
							</td>
							<td class="text-right">
								{{ sku.cost_price }} {{ sku.product.currency_unit }}
							</td>
							<td class="text-right">
								<strong class="text-mixpus">{{ sku.stock_count }}</strong> / <strong class="text-danger">{{ sku.no_arrival_count }}</strong>
							</td>
						</tr>
						{% endfor %}
						</tbody>
					</table>

					{% import "block/_macros.html" as macros %}
					<div class="pages-box pages-mini">
						<nav aria-label="Page navigation">
							{{ macros.pagination_widget(paginated_skus, '.ajax_search_products', supplier_id=supplier_id, reg_id=reg_id, qk=qk) }}
						</nav>
					</div>

				</div>

			</form>
		</div>
		<div class="modal-footer">
			<button type="button" class="btn btn-default" data-dismiss="modal">{{ _('Close') }}</button>
			<button type="button" id="sku-submit-btn" class="btn btn-mixpus">{{ _('Submit') }}</button>
		</div>
	</div><!-- /.modal-content -->
</div><!-- /.modal-dialog -->

<script type="text/javascript"><!--
	var data = {};

	var submit_search_handler = function () {
		var supplier_id = $('input[name=supplier_id]').val();
		var qk = $('input[name=qk]').val();
		var reg_id = $('input[name=reg_id]').val();

		$.post("{{ url_for('main.ajax_search_products') }}", {
			'supplier_id': supplier_id, 'qk': qk, 'reg_id': reg_id, 'csrf_token': mixpus.csrf_token
		}, function (result) {
			$('#table-refresh-box').html(result);
		}, 'html');
	};

	$('input.searcher').on('keydown', function (e) {
		var ev = window.event||e;
		if (ev.keyCode == 13) {
			submit_search_handler();
			return false;
		}
	});

	mixpus.hook_dropdown_menu(submit_search_handler);

	$('.pagination a').on('click', function(e) {
		e.preventDefault();

		$('#sku-modal').load($(this).attr('href'));
	});

	// 全选 or 反选
	$('#sku-form').find('input.check-all').bind('click', function() {
		if ($(this).is(':checked')){
			$(this)
				.parents('table')
				.find('.check-one')
				.prop('checked', true);
		} else {
			$(this)
				.parents('table')
				.find('.check-one')
				.prop('checked', false);
		}
	});

	$('#sku-form').find('input.check-one').click(function () {
		// 取消全选
		if (!$(this).is(':checked')) {
			$('input.check-all')
				.prop('checked', false);
		}
	});

	$('#sku-submit-btn').click(function (e) {
		data = $('#sku-form').serialize();

		$.ajax({
			url: "{{ url_for('main.ajax_find_skus') }}",
			type: 'post',
			data: data,
			dataType: 'json',
			beforeSend: function () {
				$('#sku-submit-btn').prop('disabled', true);
			},
			complete: function() {
				$('#sku-submit-btn').prop('disabled', false);
			},
			success: function (result) {
				if (result.success) {
					$('#sku-modal').modal('hide');
					// 解析结果
					$('#choose-products')
						.append(parse_result(result.data));
					recount();
				} else {
					$('#sku-form').prepend(mixpus.display_alert(result.status.message))
				}
			},
			error: function (xhr, ajaxOptions, thrownError) {
				alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
			}
		});
	});
//-->
</script>