{% extends pjax("layout/base.html") %}

{% block sidebar %}
	{% include "orders/_sub_menu.html" %}
{% endblock %}

{% block after_jquery %}
<script type="text/javascript">
	$(function () {
		mixpus.init_page_layout();

		mixpus.tracker_order_change();

		$('#add-product-btn').click(function (e) {
			var $btn = $(this), post_url=$(this).attr('href');
			var warehouse_id = $('#warehouse_id').find(':selected').eq(0).val();
			if (warehouse_id == 0) {
				swal({
					title: "Warning",
					text: "Please first choose the warehouse to ship？",
					type: "warning",
					showCancelButton: false,
					confirmButtonClass: 'btn-warning',
					confirmButtonText: "Okay, I know!",
					closeOnConfirm: true
				});
				return false;
			}

			$('#sku-modal').remove();

			$.ajax({
				url: post_url,
				type: 'post',
				dataType: 'html',
				data: {'wh_id': warehouse_id, 'csrf_token': mixpus.csrf_token, 't':'order'},
				beforeSend: function() {
					$btn.prop('disabled', true);
				},
				complete: function() {
					$btn.prop('disabled', false);
				},
				success: function(html) {
					$('body').append('<div id="sku-modal" role="dialog" class="modal">' + html + '</div>');

					$('#sku-modal').modal('show');
				}
			});

			return false;
		});

		// ajax save
		$('button.btn-save').click(function () {
			var form = $(this).data('form-id');
			$.post("{{ url_for('main.create_order') }}", $('#'+form).serialize(), function (result) {
				if (result.success) {
					window.location.href = result.data.next_url;
				} else {
                    if (result.data) {
                        for (var item in result.data) {
                            $('[name='+item+']')
                                .after('<span class="help-block">'+ result.data[item][0] +'</span>')
                                .parent()
                                .addClass('has-error');
                        }
                    }
					if (result.status && result.status.message) {
					    return mixpus.show_error_message(result.status.message);
					}
				}
			}, 'json');
		});

	});
</script>
{% endblock %}

{% block mainbar %}
<div class="form-page">
	<h2 class="page-header">
		{% if mode == 'create' %}
		{{ _('Add Order') }}
		{% else %}
		{{ _('Edit Order') }}
		{% endif %}

		<span class="pull-right">
			<button role="button" data-form-id="order-form" class="btn btn-icon btn-success btn-save" data-toggle="tooltip" data-original-title="{{ _('Save') }}">
				<i class="glyphicon glyphicon-floppy-save"></i>
			</button>
			<a href="{{ url_for('main.show_orders') }}" class="pjax btn btn-icon btn-default btn-back" data-toggle="tooltip" data-original-title="{{ _('Cancel') }}">
				<i class="glyphicon glyphicon-share-alt"></i>
			</a>
		</span>
	</h2>

	<form id="order-form" class="form-horizontal" action="" method="post">
		<input type="hidden" name="csrf_token" value="{{ csrf_token() }}" >

		<div class="panel">
			<div class="panel-heading">{{ _('Order Info') }}</div>
			<div class="panel-body">
				<div class="form-group">
					{{ form.serial_no.label(class="col-sm-2 control-label") }}
					<div class="col-sm-4">
						{{ form.serial_no(class="form-control", placeholder="Serial No.", readonly="readonly") }}
					</div>
					{{ form.outside_target_id.label(class="col-sm-2 control-label") }}
					<div class="col-sm-4">
						{{ form.outside_target_id(class="form-control") }}
					</div>
				</div>
				<div class="form-group required">
					{{ form.store_id.label(class="col-sm-2 control-label") }}
					<div class="col-sm-4">
						{{ form.store_id(class="form-control select2") }}
					</div>
				</div>

				<div class="form-group">
					{{ form.express_id.label(class="col-sm-2 control-label") }}
					<div class="col-sm-4">
						{{ form.express_id(class="form-control select2") }}
					</div>
					{{ form.freight.label(class="col-sm-2 control-label") }}
					<div class="col-sm-4">
						<div class="input-group">
							{{ form.freight(id="freight", class="form-control") }}
							<span class="input-group-addon">
								{{ current_site.currency }}
							</span>
						</div>
					</div>
				</div>

			</div>
		</div>

		<div class="panel">
			<div class="panel-heading">{{ _('Customer Info') }}</div>
			<div class="panel-body">
				<div class="form-group">
					{{ form.buyer_country.label(class="col-sm-2 control-label") }}
					<div class="col-sm-4">
						<select class="form-control select2" name="store_id">
							<option value="1">{{ _('China') }}</option>
						</select>
					</div>
					<label class="col-sm-2 control-label">{{ _('币种') }}</label>
					<div class="col-sm-4">
						<input type="text" class="form-control" readonly="readonly" placeholder="{{ current_site.currency }}">
					</div>
				</div>

				<div class="form-group required">
					{{ form.buyer_name.label(class="col-sm-2 control-label") }}
					<div class="col-sm-4">
						{{ form.buyer_name(class="form-control", placeholder="") }}
					</div>
					{{ form.buyer_phone.label(class="col-sm-2 control-label") }}
					<div class="col-sm-4">
						{{ form.buyer_phone(class="form-control", placeholder="") }}
					</div>
				</div>

				<div class="form-group">
					{{ form.buyer_tel.label(class="col-sm-2 control-label") }}
					<div class="col-sm-4">
						{{ form.buyer_tel(class="form-control", placeholder="") }}
					</div>
				</div>

				<div class="form-group">
					{{ form.buyer_province.label(class="col-sm-2 control-label") }}
					<div class="col-sm-2">
						{{ form.buyer_province(class="form-control", placeholder="") }}
					</div>
					{{ form.buyer_city.label(class="col-sm-2 control-label") }}
					<div class="col-sm-2">
						{{ form.buyer_city(class="form-control", placeholder="") }}
					</div>
					{{ form.buyer_area.label(class="col-sm-2 control-label") }}
					<div class="col-sm-2">
						{{ form.buyer_area(class="form-control") }}
					</div>
				</div>

				<div class="form-group required">
					{{ form.buyer_address.label(class="col-sm-2 control-label") }}
					<div class="col-sm-6">
						{{ form.buyer_address(class="form-control", placeholder="") }}
					</div>
					{{ form.buyer_zipcode.label(class="col-sm-2 control-label") }}
					<div class="col-sm-2">
						{{ form.buyer_zipcode(class="form-control") }}
					</div>
				</div>

				<div class="form-group">
					{{ form.buyer_remark.label(class="col-sm-2 control-label") }}
					<div class="col-sm-10">
						{{ form.buyer_remark(class="form-control", placeholder="") }}
					</div>
				</div>
			</div>
		</div>

		<div class="panel">
			<div class="panel-heading">{{ _('Product Info') }}</div>
			<div class="panel-body">
				<div class="form-group required">
					{{ form.warehouse_id.label(class="col-sm-2 control-label") }}
					<div class="col-sm-4">
						{{ form.warehouse_id(class="form-control select2") }}
					</div>
					<div class="col-sm-6">
						<a class="btn btn-warning" href="{{ url_for('main.ajax_select_products') }}" id="add-product-btn" role="button" data-toggle="tooltip" data-original-title="{{ _('Select Products') }}">
							<i class="glyphicon glyphicon-plus" aria-hidden="true"></i> {{ _('Select Products') }}
						</a>
					</div>
				</div>

				<table class="table table-bordered m-t-20 m-b-30">
					<thead>
						<tr>
							<th>{{ _('Product Info') }}</th>
							<th>{{ _('Mode/Color') }}</th>
							<th class="text-center">{{ _('Price') }}</th>
							<th class="text-center">{{ _('Deal Price') }}</th>
							<th class="text-center">{{ _('Quantity') }}</th>
							<th class="text-center">{{ _('Discount') }}</th>
							<th class="text-right">{{ _('Pay Amount') }}</th>
							<th class="text-right">{{ _('Action') }}</th>
						</tr>
					</thead>
					<tbody id="choose-products">
					{% if mode == 'edit' %}
						{% for item in current_order.items %}
						<tr id="tr_stock_{{ item.sku_id }}">
							<td>
								<img src="{{ item.sku.cover.view_url }}" width="60px" class="pull-left">
								<div class="product-info">
									{{ item.sku.serial_no }}<br>
									{{ item.sku.product_name }}<br>
								</div>
							</td>
							<td>
								{% if item.sku.s_model %}
								<label class="label label-warning">
									{{ item.sku.s_model|supress_none }}
								</label>
								{% endif %}
								{% if item.sku.s_color %}
								<label class="label label-default">
									{{ item.sku.s_color|supress_none }}
								</label>
								{% endif %}
							</td>
							<td class="text-center">
								<strong id="sale_price_{{ item.sku_id }}">{{ item.sku.sale_price }}</strong>
							</td>
							<td class="text-center">
								<strong id="deal_price_{{ item.sku_id }}">{{ item.deal_price }}</strong>
							</td>
							<td class="text-center">
								<input type="text" name="quantity[{{ item.sku_id }}]" value="{{ item.quantity }}" data-id="{{ item.sku_id }}" id="quantity_{{ item.sku_id }}" class="form-control quantity input-quantity">
								<input type="hidden" name="items[]" value="{{ item.sku_id }}">
							</td>
							<td class="text-center">
								<input type="text" name="discount[{{ item.sku_id }}]" value="{{ item.discount_amount }}" data-id="{{ item.sku_id }}" id="discount_{{ item.sku_id }}" class="form-control input-quantity">
							</td>
							<td class="text-right">
								<strong id="subtotal_{{ item.sku_id }}">{{ item.deal_price *  item.quantity }}</strong>
							</td>
							<td class="text-right">
								<a href="javascript:void(0);" class="btn btn-link disabled">{{ _('Remove') }}</a>
							</td>
						</tr>
						{% endfor %}
					{% endif %}
					</tbody>

					<tfoot class="active">
						<tr>
							<th>
								{{ _('Total') }} <strong class="text-danger" id="total_quantity">{{ current_order.items_count }}</strong> {{ _('Products') }}
							</th>
							<th colspan="3" class="text-center">
								{{ _('Total Amount:') }} <strong class="text-danger" id="total_amount">{{ current_order.total_amount }}</strong> {{ current_site.currency }} - {{ _('Total Discount:') }} <strong class="text-danger" id="total_discount">0</strong> {{ current_site.currency }}
							</th>
							<th colspan="2" class="text-right">
								{{ _('Payable Amount:') }} <strong class="text-danger" id="payable_amount">{{ current_order.pay_amount }}</strong> {{ current_site.currency }}
							</th>
						</tr>
					</tfoot>
				</table>
			</div>
		</div>

		<div class="panel">
			<div class="panel-heading">{{ _('Order Remark') }}</div>
			<div class="panel-body">
				<div class="form-group">
					<div class="col-sm-12">
						{{ form.remark(class="form-control input-lg") }}
					</div>
				</div>
			</div>
		</div>

	</form>

</div>
{% endblock %}